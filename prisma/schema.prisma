generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CircleStatus {
  active
  finished
  archived
}

enum CircleMembershipStatus {
  active
  left
}

model Device {
  id           String              @id
  createdAt    DateTime            @default(now())
  memberships  CircleMembership[]
  messages     Message[]
  user         User?
}

model Circle {
  id           String              @id @default(cuid())
  mood         String
  interest     String
  status       CircleStatus        @default(active)
  maxMembers   Int
  startsAt     DateTime
  endsAt       DateTime
  expiresAt    DateTime
  icebreaker   String              @default("Поделись, что сегодня тебя порадовало? ✨")
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  memberships  CircleMembership[]
  messages     Message[]
  reports      Report[]
}

model CircleMembership {
  id        String                   @id @default(cuid())
  circleId  String
  deviceId  String
  status    CircleMembershipStatus   @default(active)
  joinedAt  DateTime                 @default(now())
  leftAt    DateTime?

  circle    Circle                   @relation(fields: [circleId], references: [id], onDelete: Cascade)
  device    Device                   @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([circleId, status])
  @@index([deviceId, status])
}

model Message {
  id        String    @id @default(cuid())
  circleId  String
  deviceId  String?
  userId    String?
  content   String
  isSystem  Boolean   @default(false)
  createdAt DateTime  @default(now())

  circle    Circle    @relation(fields: [circleId], references: [id], onDelete: Cascade)
  device    Device?   @relation(fields: [deviceId], references: [id], onDelete: SetNull)
  user      User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([circleId, createdAt])
}

model User {
  id        String    @id @default(cuid())
  deviceId  String    @unique
  nickname  String
  avatarKey String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  device   Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  messages Message[]
  reportsSent    Report[] @relation("reportsSent")
  reportsReceived Report[] @relation("reportsReceived")
  blocksInitiated Block[]  @relation("blocksInitiated")
  blocksReceived  Block[]  @relation("blocksReceived")
}

model Report {
  id         String   @id @default(cuid())
  reporterId String
  targetId   String
  circleId   String
  messageId  String?
  reason     String
  createdAt  DateTime @default(now())

  reporter User   @relation("reportsSent", fields: [reporterId], references: [id], onDelete: Cascade)
  target   User   @relation("reportsReceived", fields: [targetId], references: [id], onDelete: Cascade)
  circle   Circle @relation(fields: [circleId], references: [id], onDelete: Cascade)
  message  Message? @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([circleId])
  @@index([targetId])
}

model Block {
  id         String   @id @default(cuid())
  blockerId  String
  blockedId  String
  createdAt  DateTime @default(now())

  blocker User @relation("blocksInitiated", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("blocksReceived", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
}
